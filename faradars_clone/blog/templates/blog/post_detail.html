{% extends 'base.html' %}
{% load static %}

{% block title %}{{ post.title }}{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'blog/style.css' %}">
  <link rel="alternate" type="application/rss+xml" title="آخرین پست‌ها" href="{% url 'blog:post_feed' %}">
{% endblock %}

{% block content %}
<div class="container my-4">
  <article class="mb-5">
    <h1 class="mb-3">{{ post.title }}</h1>
    {% if post.thumbnail %}
      <img src="{{ post.thumbnail.url }}" class="img-fluid mb-4" alt="{{ post.title }}">
    {% endif %}

<div class="mb-3 d-flex align-items-center gap-2">
  {% if post.author.profile.avatar %}
    <img src="{{ post.author.profile.avatar.url }}"
         alt="{{ post.author.username }}"
         class="rounded-circle me-2"
         width="32" height="32">
  {% endif %}
  توسط
  <a href="{% url 'instructors:profile' post.author.username %}">
    {{ post.author.username|default:"مهمان" }}
  </a>
  <span class="text-muted">| {{ post.published_date|date:"Y/m/d H:i" }}</span>
</div>


    <div class="content mb-4">
      {{ post.content|safe }}
    </div>

    {% if post.tags.exists %}
      <p>تگ‌ها:
        {% for tag in post.tags.all %}
          <a href="{{ tag.get_absolute_url }}" class="badge bg-primary me-1">{{ tag.name }}</a>
        {% endfor %}
      </p>
    {% endif %}

    {% if post.category %}
      <p>دسته‌بندی:
        <a href="{{ post.category.get_absolute_url }}" class="badge bg-info">{{ post.category.name }}</a>
      </p>
    {% endif %}

<div class="d-flex gap-2 mb-4">
  <button id="like-btn"    class="btn btn-outline-success">
    👍 <span id="like-count">{{ post.likes }}</span>
  </button>
  <button id="dislike-btn" class="btn btn-outline-danger">
    👎 <span id="dislike-count">{{ post.dislikes }}</span>
  </button>
</div>

  </article>

  <section id="comments" class="mb-5">
    <h3>نظرات ({{ comments.count }})</h3>
    {% for comment in comments %}
      <div class="card mb-2 p-3">
        <p class="mb-1">
          <strong>{{ comment.user.username|default:"مهمان" }}</strong>
          <small class="text-muted">{{ comment.created_at|date:"Y/m/d H:i" }}</small>
        </p>
        <p>{{ comment.content }}</p>
      </div>
    {% empty %}
      <p>هنوز نظری ثبت نشده.</p>
    {% endfor %}
  </section>

  <section id="comment-form" class="mb-5">
    <h3>ارسال نظر</h3>
    <form method="post">{% csrf_token %}
      {{ form.non_field_errors }}
      <div class="mb-3">
        {{ form.content.label_tag }}
        {{ form.content }}
        {{ form.content.errors }}
      </div>
      <button type="submit" class="btn btn-primary">ارسال</button>
    </form>
  </section>

  <section id="newsletter" class="mb-5">
    <h3>اشتراک در خبرنامه</h3>
    <form method="post" action="{% url 'blog:newsletter_subscribe' %}">{% csrf_token %}
      <div class="input-group">
        <input type="email" name="email" class="form-control" placeholder="ایمیل شما…">
        <button class="btn btn-primary" type="submit">ارسال</button>
      </div>
    </form>
  </section>
</div>
{% endblock %}
{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  const likeBtn    = document.getElementById('like-btn');
  const dislikeBtn = document.getElementById('dislike-btn');

  function handleReaction(btn, url, countSpanId) {
    btn.addEventListener('click', () => {
      fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'Accept':      'application/json',
        }
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById('like-count').textContent    = data.likes;
        document.getElementById('dislike-count').textContent = data.dislikes;
      });
    });
  }

  const slug = '{{ post.slug }}';
  handleReaction(likeBtn,    '{% url "blog:like_post" post.slug %}');
  handleReaction(dislikeBtn, '{% url "blog:dislike_post" post.slug %}');
});
</script>
{% endblock %}
